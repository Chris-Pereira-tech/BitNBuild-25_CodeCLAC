<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GourmetNet AI - Community Forum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            color: #d1d5db;
            background-color: #111827;
        }

        #background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #111827);
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Glassmorphism Card Style */
        .card {
            background: rgba(31, 41, 55, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>

<body class="bg-gray-900">
    <div id="background-container"></div>
    
    <!-- Navigation Header -->
    <nav class="bg-gray-900/30 backdrop-blur-md shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <span class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-orange-400 to-amber-400">GourmetNet AI</span>
                </div>
                <div class="flex space-x-4">
                    <a href="ingredient_recognizer.html" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors">Recipe Tool</a>
                    <a href="dashboard.html" class="bg-gray-800 text-white px-3 py-2 rounded-md text-sm font-medium" aria-current="page">Community Forum</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="w-full max-w-5xl mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-100">Community Forum üßë‚Äçüç≥</h1>
            <p class="text-gray-400 mt-3 text-lg">Share your creations, ask questions, and connect with other foodies.</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Left Column: Create Post -->
            <div class="md:col-span-1 space-y-6">
                <div class="card p-6">
                    <h2 class="text-xl font-semibold text-gray-200 mb-4">Create a New Post</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="postTitle" class="block text-sm font-medium text-gray-400 mb-1">Title</label>
                            <input type="text" id="postTitle" class="block w-full px-4 py-2 text-gray-200 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" placeholder="e.g., My Perfect Sushi Rice!">
                        </div>
                        <div>
                            <label for="postContent" class="block text-sm font-medium text-gray-400 mb-1">Content</label>
                            <textarea id="postContent" rows="5" class="block w-full px-4 py-2 text-gray-200 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" placeholder="Share your recipe, question, or tip..."></textarea>
                        </div>
                        <div>
                            <label for="postAuthor" class="block text-sm font-medium text-gray-400 mb-1">Your Name</label>
                            <input type="text" id="postAuthor" class="block w-full px-4 py-2 text-gray-200 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" placeholder="e.g., Chef Alex">
                        </div>
                        <button id="submitPostBtn" class="w-full bg-gradient-to-r from-orange-500 to-amber-500 text-white font-bold py-3 px-4 rounded-lg hover:from-orange-600 hover:to-amber-600 transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center justify-center">
                            <span id="btnTextSubmit">Submit Post</span>
                            <div id="loaderSubmit" class="loader hidden"></div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Posts Feed -->
            <div class="md:col-span-2 card p-6">
                <h2 class="text-2xl font-bold text-gray-100 mb-4">Latest Posts</h2>
                 <div id="error" class="text-red-300 p-4 bg-red-900/50 border border-red-500/50 rounded-lg hidden mb-4"></div>
                <div id="postsFeed" class="space-y-6 max-h-[80vh] overflow-y-auto pr-2">
                    <!-- Posts will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </div>

<script>
    const submitPostBtn = document.getElementById('submitPostBtn');
    const btnTextSubmit = document.getElementById('btnTextSubmit');
    const loaderSubmit = document.getElementById('loaderSubmit');
    const postTitleInput = document.getElementById('postTitle');
    const postContentInput = document.getElementById('postContent');
    const postAuthorInput = document.getElementById('postAuthor');
    const postsFeed = document.getElementById('postsFeed');
    const errorDiv = document.getElementById('error');

    document.addEventListener('DOMContentLoaded', fetchPosts);
    submitPostBtn.addEventListener('click', handlePostSubmit);

    function setLoadingState(button, loader, textElement, isLoading) {
        if (button) button.disabled = isLoading;
        if (loader) loader.classList.toggle('hidden', !isLoading);
        if (textElement) textElement.classList.toggle('hidden', isLoading);
    }

    function showError(message) {
        errorDiv.innerText = message;
        errorDiv.classList.remove('hidden');
    }

    async function handleServerResponse(response) {
        const responseText = await response.text();
        if (!response.ok) {
            try {
                const errorJson = JSON.parse(responseText);
                throw new Error(errorJson.error || `Server responded with status: ${response.status}`);
            } catch (e) {
                throw new Error(`Server error: ${response.status}. Could not parse error response.`);
            }
        }
        try {
            return JSON.parse(responseText);
        } catch (e) {
            return responseText; // Handle non-JSON success responses
        }
    }

    async function handlePostSubmit() {
        const title = postTitleInput.value.trim();
        const content = postContentInput.value.trim();
        const author = postAuthorInput.value.trim() || 'Anonymous';

        if (!title || !content) {
            showError("Please fill in both title and content.");
            return;
        }
        
        setLoadingState(submitPostBtn, loaderSubmit, btnTextSubmit, true);
        errorDiv.classList.add('hidden');

        try {
            const response = await fetch('http://localhost:3000/posts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, content, author })
            });
            const newPost = await handleServerResponse(response);
            addPostToFeed(newPost, true); // Add to top of the feed
            postTitleInput.value = '';
            postContentInput.value = '';
            postAuthorInput.value = '';
        } catch (error) {
            showError(`Error submitting post: ${error.message}`);
        } finally {
            setLoadingState(submitPostBtn, loaderSubmit, btnTextSubmit, false);
        }
    }

    async function fetchPosts() {
        try {
            const response = await fetch('http://localhost:3000/posts');
            const posts = await handleServerResponse(response);
            postsFeed.innerHTML = ''; // Clear existing posts
            if (posts.length === 0) {
                 postsFeed.innerHTML = `<p class="text-gray-500 italic">No posts yet. Be the first to start a conversation!</p>`;
            } else {
                posts.forEach(post => addPostToFeed(post));
            }
        } catch (error) {
            showError(`Error fetching posts: ${error.message}`);
        }
    }

    function addPostToFeed(post, atTop = false) {
        const postElement = document.createElement('div');
        postElement.className = 'p-5 bg-gray-800/50 rounded-lg border border-gray-700 fade-in';
        postElement.dataset.postId = post.id;

        const postHTML = `
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="text-lg font-bold text-orange-400">${post.title}</h3>
                    <p class="text-xs text-gray-500">by ${post.author} on ${new Date(post.createdAt.seconds * 1000).toLocaleString()}</p>
                </div>
            </div>
            <p class="text-gray-300 mt-3 whitespace-pre-wrap">${post.content}</p>
            
            <!-- Comments Section -->
            <div class="mt-5 border-t border-gray-700 pt-4">
                <h4 class="text-sm font-semibold text-gray-400 mb-2">Comments</h4>
                <div class="comments-container space-y-3">
                    <!-- Comments will be loaded here -->
                    ${renderComments(post.comments || [])}
                </div>
                <div class="mt-4 flex gap-2">
                    <input type="text" class="comment-input flex-grow block w-full px-3 py-2 text-gray-200 bg-gray-700 border border-gray-600 rounded-md text-sm focus:ring-1 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="Add a comment...">
                    <button class="submit-comment-btn bg-teal-500 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-600 transition-colors text-sm">Reply</button>
                </div>
            </div>
        `;
        postElement.innerHTML = postHTML;

        // Clear placeholder text if it exists
        const placeholder = postsFeed.querySelector('p');
        if (placeholder && placeholder.textContent.startsWith('No posts yet.')) {
            postsFeed.innerHTML = '';
        }

        if (atTop) {
            postsFeed.prepend(postElement);
        } else {
            postsFeed.appendChild(postElement);
        }
        
        // Add event listener for the new comment button
        postElement.querySelector('.submit-comment-btn').addEventListener('click', handleCommentSubmit);
    }
    
    function renderComments(comments) {
        if (!comments || comments.length === 0) {
            return `<p class="text-xs text-gray-500 italic no-comments">No comments yet.</p>`;
        }
        return comments.map(comment => `
            <div class="p-3 bg-gray-900/60 rounded-md text-sm">
                <p class="text-gray-300">${comment.text}</p>
                <p class="text-xs text-gray-500 mt-1 text-right">- ${comment.author} on ${new Date(comment.createdAt.seconds * 1000).toLocaleString()}</p>
            </div>
        `).join('');
    }

    async function handleCommentSubmit(event) {
        const button = event.target;
        const postElement = button.closest('[data-post-id]');
        const postId = postElement.dataset.postId;
        const commentInput = postElement.querySelector('.comment-input');
        const text = commentInput.value.trim();

        if (!text) return;
        
        // For simplicity, we'll prompt for a name. In a real app, this would come from a user session.
        const author = prompt("Please enter your name for the comment:", "Guest");
        if (!author) return; // User cancelled prompt

        button.disabled = true;
        button.textContent = '...';

        try {
            const response = await fetch(`http://localhost:3000/posts/${postId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text, author })
            });
            const updatedPost = await handleServerResponse(response);
            
            // Re-render comments for this post
            const commentsContainer = postElement.querySelector('.comments-container');
            commentsContainer.innerHTML = renderComments(updatedPost.comments);
            commentInput.value = '';

        } catch (error) {
             showError(`Error posting comment: ${error.message}`);
        } finally {
            button.disabled = false;
            button.textContent = 'Reply';
        }
    }
</script>
</body>
</html>

