<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GourmetNet AI - Modern Recipe Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            color: #d1d5db; /* Light gray text */
            background-color: #111827;
        }

        #background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #111827);
            background-size: 400% 400%;
            animation: gradientBG 20s ease infinite;
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Glassmorphism Card Style */
        .card {
            background: rgba(31, 41, 55, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        #combinedIngredientsList li, .checklist-item {
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            background-color: #374151;
            color: #e5e7eb;
            border-radius: 0.375rem;
            border: 1px solid #4b5563;
        }

        .remove-btn {
            background-color: transparent;
            color: #fca5a5;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 16px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .remove-btn:hover { background-color: #450a0a; color: #fecaca; }

        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: #1f2937; color: #d1d5db; margin: 10% auto; padding: 2rem;
            border: 1px solid #4b5563; width: 90%; max-width: 600px; border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .close-button { color: #9ca3af; float: right; font-size: 28px; font-weight: bold; transition: color 0.2s ease; }
        .close-button:hover, .close-button:focus { color: #e5e7eb; text-decoration: none; cursor: pointer; }
        
        .favourite-btn { background: none; border: none; cursor: pointer; font-size: 1.5rem; transition: transform 0.2s ease; }
        .favourite-btn:hover { transform: scale(1.2); }
    </style>
</head>

<body>
    <div id="background-container"></div>
    
    <!-- Navigation Header -->
    <nav class="bg-gray-900/30 backdrop-blur-md shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <span class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-orange-400 to-amber-400">GourmetNet AI</span>
                </div>
                <div class="flex space-x-4">
                    <a href="ingredient_recognizer.html" class="bg-gray-800 text-white px-3 py-2 rounded-md text-sm font-medium" aria-current="page">Recipe Tool</a>
                    <a href="dashboard.html" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium transition-colors">Community Forum</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main App Container -->
    <div id="appContainer">
        <div class="w-full max-w-5xl mx-auto p-4 md:p-8">
            <header class="text-center mb-10">
                <h1 class="text-4xl md:text-5xl font-bold text-gray-100">GourmetNet AI üç≥</h1>
                <p class="text-gray-400 mt-3 text-lg">Your intelligent partner in the kitchen.</p>
            </header>

            <div id="dashboardContainer" class="card p-6 mb-10">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-100 mb-3">üåü Popular Recipes</h2>
                        <ul id="popularRecipesList" class="space-y-2">
                            <li class="text-gray-500">Loading popular recipes...</li>
                        </ul>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-100 mb-3">‚ù§Ô∏è Favourite Recipes</h2>
                        <ul id="favouriteRecipesList" class="space-y-2">
                            <li class="text-gray-500">Loading your favourites...</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <!-- Left Column: Inputs -->
                <div class="space-y-6">
                    <div class="card p-6">
                        <label for="dishName" class="block text-lg font-semibold text-gray-200 mb-2">1. Get Recipe by Dish Name</label>
                         <div class="flex gap-2">
                            <input type="text" id="dishName" class="block w-full px-4 py-2 text-gray-200 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" placeholder="e.g., Sushi, Lasagna">
                            <button id="getIngredientsByNameBtn" class="bg-orange-500 text-white font-bold py-2 px-5 rounded-lg hover:bg-orange-600 transition-all duration-300 transform hover:scale-105 shadow-sm hover:shadow-md flex items-center justify-center disabled:bg-gray-500">
                                <span id="btnTextByName">Get</span>
                                <div id="loaderByName" class="loader hidden"></div>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">This will fetch ingredients for you to confirm.</p>
                    </div>

                    <div class="text-center text-gray-500 font-bold">OR</div>

                    <div class="card p-6">
                        <h2 class="text-lg font-semibold text-gray-200 mb-2">2. Get Recipe from Your Ingredients</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="recipeUrl" class="block text-sm font-medium text-gray-400 mb-1">Add from Website</label>
                                 <div class="flex gap-2">
                                    <input type="url" id="recipeUrl" class="block w-full px-4 py-2 text-gray-200 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" placeholder="Paste a recipe URL">
                                    <button id="scrapeBtn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 transition-all duration-300 transform hover:scale-105 flex items-center justify-center disabled:bg-gray-500">
                                        <span id="btnTextScrape">Extract</span>
                                        <div id="loaderScrape" class="loader hidden"></div>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label for="imageUpload" class="block text-sm font-medium text-gray-400 mb-1">Add from Photo</label>
                                <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gray-700 file:text-orange-300 hover:file:bg-gray-600 transition">
                                 <div id="imagePreviewContainer" class="mt-4 hidden">
                                     <img id="imagePreview" src="#" alt="Image Preview" class="max-w-xs mx-auto rounded-lg shadow-md">
                                </div>
                                <button id="identifyBtn" class="mt-2 w-full bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 transition-all duration-300 transform hover:scale-105 flex items-center justify-center disabled:bg-gray-500">
                                    <span id="btnText1">Identify & Add</span>
                                    <div id="loader1" class="loader hidden"></div>
                                </button>
                            </div>
                            <div>
                                <label for="manualIngredients" class="block text-sm font-medium text-gray-400 mb-1">Add Manually</label>
                                <div class="flex gap-2">
                                    <input type="text" id="manualIngredients" class="block w-full px-4 py-2 text-gray-200 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition" placeholder="e.g., chicken, rice">
                                    <button id="addManualBtn" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 transition-all duration-300 transform hover:scale-105">Add</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Combined List & Customization -->
                <div class="card p-6 space-y-6">
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-2xl font-bold text-gray-100">Your Ingredient List</h2>
                            <button id="clearListBtn" class="text-sm text-red-400 hover:underline">Clear List</button>
                        </div>
                        <div id="combinedIngredientsContainer" class="p-4 bg-gray-900 rounded-lg border border-gray-700 text-gray-300 min-h-[150px] max-h-48 overflow-y-auto">
                            <ul id="combinedIngredientsList"></ul>
                        </div>
                    </div>

                    <div>
                         <h2 class="text-2xl font-bold text-gray-100 mb-3">Customize Your Recipe</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="cookingTime" class="block text-sm font-medium text-gray-400">Max Cooking Time</label>
                                <select id="cookingTime" class="mt-1 block w-full py-2 px-3 border border-gray-600 bg-gray-700 text-gray-200 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm transition">
                                    <option>Any</option>
                                    <option>Under 30 minutes</option>
                                    <option>30-60 minutes</option>
                                    <option>Over 60 minutes</option>
                                </select>
                            </div>
                            <div>
                                <label for="diet" class="block text-sm font-medium text-gray-400">Dietary Preference</label>
                                <select id="diet" class="mt-1 block w-full py-2 px-3 border border-gray-600 bg-gray-700 text-gray-200 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm transition">
                                    <option>None</option>
                                    <option>Vegetarian</option>
                                    <option>Vegan</option>
                                    <option>Gluten-Free</option>
                                    <option>Dairy-Free</option>
                                    <option>Nut-Free</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                             <label for="allergies" class="block text-sm font-medium text-gray-400">Allergies</label>
                            <input type="text" id="allergies" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm transition" placeholder="e.g., peanuts, shellfish">
                        </div>
                        <div class="mt-4">
                             <label for="cookingStyle" class="block text-sm font-medium text-gray-400">Cooking Style</label>
                            <input type="text" id="cookingStyle" class="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 text-gray-200 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm transition" placeholder="e.g., Gordon Ramsay, Italian">
                        </div>
                    </div>

                    <button id="finalGetRecipeBtn" class="w-full bg-gradient-to-r from-orange-500 to-amber-500 text-white font-bold py-3 px-4 rounded-lg hover:from-orange-600 hover:to-amber-600 transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                        <span id="btnTextFinal">‚ú® Generate Recipe from List</span>
                        <div id="loaderFinal" class="loader hidden"></div>
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results" class="mt-10">
                 <div id="recipeContainer" class="hidden card p-6">
                    <div id="recipeOutput" class="text-gray-300"></div>
                </div>
                 <div id="error" class="text-red-300 p-4 bg-red-900/50 border border-red-500/50 rounded-lg hidden mt-8"></div>
                 <div id="shoppingLinksContainer" class="hidden card p-6 mt-6"></div>
            </div>

            <!-- Saved Recipes Section -->
            <div class="mt-10">
                <button id="viewSavedBtn" class="w-full bg-gray-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors duration-300 transform hover:scale-105 shadow-md">View All Saved Recipes</button>
                <div id="savedRecipesContainer" class="mt-4 hidden card p-6">
                    <h2 class="text-2xl font-bold text-gray-100 mb-2">Saved Recipes:</h2>
                    <ul id="savedRecipesList" class="space-y-2"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="recipeModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div id="modalRecipeContent"></div>
        </div>
    </div>
    <div id="ingredientChecklistModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-gray-100 mb-4">Confirm Your Ingredients</h2>
            <p class="text-gray-400 mb-4">Uncheck the ingredients you don't have.</p>
            <div id="checklistContainer" class="space-y-2 max-h-64 overflow-y-auto mb-6"></div>
            <button id="confirmIngredientsBtn" class="w-full bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                Continue
            </button>
        </div>
    </div>
    <div id="choiceModal" class="modal">
        <div class="modal-content">
             <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-gray-100 mb-4">How to Proceed?</h2>
            <p class="text-gray-400 mb-6">Would you like a recipe using only the ingredients you have, or the full recipe (and we'll show you links to buy what you're missing)?</p>
            <div class="flex space-x-4">
                <button id="useHaveBtn" class="flex-1 bg-teal-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-600 transition-colors">
                    Use What I Have
                </button>
                <button id="useAllBtn" class="flex-1 bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 transition-colors">
                    Use Full Recipe
                </button>
            </div>
        </div>
    </div>

<script>
    const apiKey = "YOUR_GEMINI_API_KEY"; // Replace with your actual Gemini API key if needed for client-side operations

    const imageUpload = document.getElementById('imageUpload');
    const identifyBtn = document.getElementById('identifyBtn');
    const errorDiv = document.getElementById('error');
    const imagePreview = document.getElementById('imagePreview');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const loader1 = document.getElementById('loader1');
    const btnText1 = document.getElementById('btnText1');
    const recipeContainer = document.getElementById('recipeContainer');
    const recipeOutput = document.getElementById('recipeOutput');
    const manualIngredientsInput = document.getElementById('manualIngredients');
    const addManualBtn = document.getElementById('addManualBtn');
    const combinedIngredientsList = document.getElementById('combinedIngredientsList');
    const clearListBtn = document.getElementById('clearListBtn');
    const finalGetRecipeBtn = document.getElementById('finalGetRecipeBtn');
    const btnTextFinal = document.getElementById('btnTextFinal');
    const loaderFinal = document.getElementById('loaderFinal');
    const viewSavedBtn = document.getElementById('viewSavedBtn');
    const savedRecipesContainer = document.getElementById('savedRecipesContainer');
    const savedRecipesList = document.getElementById('savedRecipesList');
    
    const recipeModal = document.getElementById('recipeModal');
    const modalRecipeContent = document.getElementById('modalRecipeContent');
    const recipeModalCloseBtn = recipeModal.querySelector('.close-button');
    const ingredientChecklistModal = document.getElementById('ingredientChecklistModal');
    const checklistContainer = document.getElementById('checklistContainer');
    const confirmIngredientsBtn = document.getElementById('confirmIngredientsBtn');
    const checklistModalCloseBtn = ingredientChecklistModal.querySelector('.close-button');
    const choiceModal = document.getElementById('choiceModal');
    const useHaveBtn = document.getElementById('useHaveBtn');
    const useAllBtn = document.getElementById('useAllBtn');
    const choiceModalCloseBtn = choiceModal.querySelector('.close-button');

    const recipeUrlInput = document.getElementById('recipeUrl');
    const scrapeBtn = document.getElementById('scrapeBtn');
    const btnTextScrape = document.getElementById('btnTextScrape');
    const loaderScrape = document.getElementById('loaderScrape');
    
    const dishNameInput = document.getElementById('dishName');
    const getIngredientsByNameBtn = document.getElementById('getIngredientsByNameBtn');
    const btnTextByName = document.getElementById('btnTextByName');
    const loaderByName = document.getElementById('loaderByName');

    const cookingTimeSelect = document.getElementById('cookingTime');
    const dietSelect = document.getElementById('diet');
    const allergiesInput = document.getElementById('allergies');
    const cookingStyleInput = document.getElementById('cookingStyle');
    const shoppingLinksContainer = document.getElementById('shoppingLinksContainer');
    
    let imageData = null;
    let combinedIngredients = [];
    let savedRecipes = {}; // Use an object to store recipes by ID
    let tempIngredientLists = {};
    
    document.addEventListener('DOMContentLoaded', () => {
        loadDashboard();
    });

    imageUpload.addEventListener('change', handleImageUpload);
    identifyBtn.addEventListener('click', identifyAndAddIngredients);
    addManualBtn.addEventListener('click', addManualIngredients);
    scrapeBtn.addEventListener('click', scrapeAndAddIngredients);
    clearListBtn.addEventListener('click', clearCombinedList);
    finalGetRecipeBtn.addEventListener('click', () => fetchRecipeFromIngredients(combinedIngredients));
    getIngredientsByNameBtn.addEventListener('click', fetchIngredientsForDish);
    viewSavedBtn.addEventListener('click', fetchAndShowSavedRecipes);
    recipeModalCloseBtn.onclick = () => recipeModal.style.display = "none";
    checklistModalCloseBtn.onclick = () => ingredientChecklistModal.style.display = "none";
    choiceModalCloseBtn.onclick = () => choiceModal.style.display = "none";

    window.onclick = (event) => {
        if (event.target == recipeModal) recipeModal.style.display = "none";
        if (event.target == ingredientChecklistModal) ingredientChecklistModal.style.display = "none";
        if (event.target == choiceModal) choiceModal.style.display = "none";
    }

    savedRecipesList.addEventListener('click', (event) => {
        const li = event.target.closest('li');
        if (li && li.dataset.recipeId) {
            const recipeId = li.dataset.recipeId;
            const recipe = savedRecipes[recipeId];
            if (recipe) {
                openRecipeModal(recipe);
            }
        }
    });

    confirmIngredientsBtn.addEventListener('click', handleIngredientConfirmation);
    useHaveBtn.addEventListener('click', () => {
        choiceModal.style.display = 'none';
        fetchRecipeFromIngredients(tempIngredientLists.have);
        generateShoppingLinks(tempIngredientLists.need);
    });
    useAllBtn.addEventListener('click', () => {
        choiceModal.style.display = 'none';
        const allIngredients = [...tempIngredientLists.have, ...tempIngredientLists.need];
        fetchRecipeFromIngredients(allIngredients);
        generateShoppingLinks(tempIngredientLists.need);
    });

    function openRecipeModal(fullRecipe) {
        modalRecipeContent.innerHTML = '';
        const nutritionDiv = renderNutrition(fullRecipe.nutrition);
        modalRecipeContent.appendChild(nutritionDiv);
        renderRecipe(fullRecipe, modalRecipeContent);
        recipeModal.style.display = "block";
    }

    function renderRecipe(fullRecipe, containerElement) {
        const recipeData = fullRecipe.recipe;
        
        const headerDiv = document.createElement('div');
        headerDiv.className = 'flex justify-between items-start mb-2';

        const title = document.createElement('h2');
        title.className = 'text-3xl font-bold text-orange-400';
        title.textContent = recipeData.title;

        const favouriteBtn = document.createElement('button');
        favouriteBtn.className = 'favourite-btn';
        favouriteBtn.textContent = fullRecipe.isFavourite ? '‚ù§Ô∏è' : 'ü§ç';
        favouriteBtn.dataset.recipeId = fullRecipe.id;
        favouriteBtn.onclick = () => toggleFavourite(fullRecipe.id, favouriteBtn);

        headerDiv.appendChild(title);
        headerDiv.appendChild(favouriteBtn);
        
        const description = document.createElement('p');
        description.className = 'text-gray-400 italic mb-4';
        description.textContent = recipeData.description;

        const statsContainer = document.createElement('div');
        statsContainer.className = 'flex items-center space-x-4 text-sm text-gray-400 mb-6 border-b border-gray-700 pb-4';
        statsContainer.innerHTML = `
            <span><strong>Prep:</strong> ${recipeData.prepTime}</span>
            <span><strong>Cook:</strong> ${recipeData.cookTime}</span>
            <span><strong>Servings:</strong> ${recipeData.servings}</span>
        `;

        const ingredientsTitle = document.createElement('h3');
        ingredientsTitle.className = 'text-xl font-bold mb-2 text-gray-200';
        ingredientsTitle.textContent = 'Ingredients';

        const ingredientsList = document.createElement('ul');
        ingredientsList.className = 'list-disc list-inside space-y-1 mb-6';
        if(Array.isArray(recipeData.ingredients)) {
            recipeData.ingredients.forEach(ing => {
                const li = document.createElement('li');
                li.textContent = ing;
                ingredientsList.appendChild(li);
            });
        }

        const instructionsTitle = document.createElement('h3');
        instructionsTitle.className = 'text-xl font-bold mb-2 text-gray-200';
        instructionsTitle.textContent = 'Instructions';

        const instructionsList = document.createElement('ol');
        instructionsList.className = 'list-decimal list-inside space-y-2';
         if(Array.isArray(recipeData.instructions)) {
            recipeData.instructions.forEach(step => {
                const li = document.createElement('li');
                li.textContent = step;
                instructionsList.appendChild(li);
            });
        }

        containerElement.appendChild(headerDiv);
        containerElement.appendChild(description);
        containerElement.appendChild(statsContainer);
        containerElement.appendChild(ingredientsTitle);
        containerElement.appendChild(ingredientsList);
        containerElement.appendChild(instructionsTitle);
        containerElement.appendChild(instructionsList);
    }

    function renderNutrition(nutritionData) {
        const nutritionContainer = document.createElement('div');
        nutritionContainer.className = 'mb-6 p-4 border border-gray-700 rounded-lg bg-gray-900/50';
        
        let nutritionHTML = `<h3 class="font-bold text-lg mb-3 text-center text-gray-200">Estimated Nutrition (per serving)</h3><div class="space-y-2 text-sm">`;
        
        const mainNutrients = ['calories', 'protein', 'carbs', 'fat'];
        mainNutrients.forEach(key => {
            if (nutritionData && nutritionData[key]) {
                 nutritionHTML += `<div class="flex justify-between items-center border-t border-gray-700 pt-2 mt-2">
                                <span class="font-semibold text-gray-400">${key.charAt(0).toUpperCase() + key.slice(1)}:</span>
                                <span class="font-bold text-lg text-gray-100">${nutritionData[key].value} ${nutritionData[key].unit}</span>
                            </div>`;
            }
        });

        const otherNutrients = ['vitaminC', 'iron', 'calcium'];
        let detailedHTML = '';
         otherNutrients.forEach(key => {
            if (nutritionData && nutritionData[key]) {
                const name = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                detailedHTML += `<div>
                                    <p class="font-semibold text-gray-400">${name}</p>
                                    <p class="font-bold text-lg text-gray-100">${nutritionData[key].value} ${nutritionData[key].unit}</p>
                                </div>`;
            }
        });

        if (detailedHTML) {
            nutritionHTML += `<div class="border-t border-gray-700 pt-2 mt-2 grid grid-cols-2 md:grid-cols-3 gap-2 text-center">${detailedHTML}</div>`;
        }

        nutritionHTML += `</div>`;
        nutritionContainer.innerHTML = nutritionHTML;
        return nutritionContainer;
    }

    function handleImageUpload(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                imageData = event.target.result.split(',')[1];
                imagePreview.src = event.target.result;
                imagePreviewContainer.classList.remove('hidden');
                imagePreviewContainer.classList.add('fade-in');
            };
            reader.readAsDataURL(file);
        }
    }

    function setLoadingState(button, loader, textElement, isLoading) {
        button.disabled = isLoading;
        if (isLoading) {
            loader.classList.remove('hidden');
            textElement.classList.add('hidden');
        } else {
            loader.classList.add('hidden');
            textElement.classList.remove('hidden');
        }
    }

    function showError(message) {
        errorDiv.innerText = message;
        errorDiv.classList.remove('hidden');
        errorDiv.classList.add('fade-in');
    }
    
    function updateCombinedListUI() {
        combinedIngredientsList.innerHTML = '';
        if (combinedIngredients.length === 0) {
            finalGetRecipeBtn.disabled = true;
            combinedIngredientsList.innerHTML = `<li class="text-gray-500 italic !bg-transparent !border-none">Your ingredients will appear here...</li>`
            return;
        }
         finalGetRecipeBtn.disabled = false;
        combinedIngredients.forEach((ingredient, index) => {
            const li = document.createElement('li');
            li.textContent = ingredient;
            li.classList.add('fade-in');
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '&times;';
            removeBtn.className = 'remove-btn';
            removeBtn.onclick = () => {
                combinedIngredients.splice(index, 1);
                updateCombinedListUI();
            };
            li.appendChild(removeBtn);
            combinedIngredientsList.appendChild(li);
        });
    }
    
    function clearCombinedList() {
        combinedIngredients = [];
        updateCombinedListUI();
    }

    function addManualIngredients() {
        const manualText = manualIngredientsInput.value.trim();
        if (!manualText) return;
        const manualIngredientsArray = manualText.split(',').map(item => item.trim()).filter(Boolean);
        combinedIngredients.push(...manualIngredientsArray);
        updateCombinedListUI();
        manualIngredientsInput.value = '';
    }
    
    async function handleServerResponse(response) {
        const responseText = await response.text();
        if (!response.ok) {
            try {
                const errorJson = JSON.parse(responseText);
                throw new Error(errorJson.error || `Server responded with status: ${response.status}`);
            } catch (e) {
                throw new Error(`Server error: ${response.status}. Could not parse error response.`);
            }
        }
        return JSON.parse(responseText);
    }
    
    async function scrapeAndAddIngredients() {
        const url = recipeUrlInput.value.trim();
        if (!url) {
            showError("Please enter a URL.");
            return;
        }
        setLoadingState(scrapeBtn, loaderScrape, btnTextScrape, true);
        errorDiv.classList.add('hidden');

        try {
             const response = await fetch('http://localhost:3000/scrape-recipe', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ url }) 
            });
            const data = await handleServerResponse(response);
            if (data.ingredients && data.ingredients.length > 0) {
                combinedIngredients.push(...data.ingredients);
                updateCombinedListUI();
                recipeUrlInput.value = '';
            } else {
                throw new Error("No ingredients could be extracted from the URL.");
            }
        } catch (error) {
             let errorMessage = `Error: ${error.message}`;
            if (error.name === 'TypeError') errorMessage += '\n\nIs your backend server running?';
            showError(errorMessage);
        } finally {
            setLoadingState(scrapeBtn, loaderScrape, btnTextScrape, false);
        }
    }

    async function identifyAndAddIngredients() {
        if (!imageData) {
            showError('Please upload an image first.');
            return;
        }
        setLoadingState(identifyBtn, loader1, btnText1, true);
        errorDiv.classList.add('hidden');
        
        const model = 'gemini-2.5-flash-preview-05-20';
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        const payload = { contents: [{ parts: [{ text: "Identify the distinct cooking ingredients in this image. List them separated by commas." }, { inlineData: { mimeType: "image/jpeg", data: imageData } }] }] };

        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                const errorJson = await response.json();
                throw new Error(`API Error ${response.status}: ${errorJson.error.message}`);
            }
            const data = await response.json();
            if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) {
                const ingredientsText = data.candidates[0].content.parts[0].text;
                const identifiedArray = ingredientsText.split(',').map(item => item.trim()).filter(Boolean);
                combinedIngredients.push(...identifiedArray);
                updateCombinedListUI();
            } else {
                throw new Error("No ingredients identified.");
            }
        } catch (error) {
            showError(`Error: ${error.message}`);
        } finally {
            setLoadingState(identifyBtn, loader1, btnText1, false);
        }
    }
    
    async function fetchRecipeFromIngredients(ingredients) {
        if (ingredients.length === 0) {
            showError('Please add or select some ingredients first.');
            return;
        }
        setLoadingState(finalGetRecipeBtn, loaderFinal, btnTextFinal, true);
        errorDiv.classList.add('hidden');
        recipeContainer.classList.add('hidden');

        const recipeOptions = {
            ingredients: ingredients,
            time: cookingTimeSelect.value,
            diet: dietSelect.value,
            allergies: allergiesInput.value.trim(),
            cookingStyle: cookingStyleInput.value.trim()
        };

        try {
            const response = await fetch('http://localhost:3000/get-recipe', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(recipeOptions) 
            });
            const data = await handleServerResponse(response);
            
            recipeOutput.innerHTML = '';
            const nutritionDiv = renderNutrition(data.nutrition);
            recipeOutput.prepend(nutritionDiv);
            
            renderRecipe(data, recipeOutput); 
            
            recipeContainer.classList.remove('hidden');
            loadDashboard(); // Refresh dashboard after generating to update counts
        } catch (error) {
            let errorMessage = `Error: ${error.message}`;
            if (error.name === 'TypeError') errorMessage += '\n\nIs your backend server running?';
            showError(errorMessage);
        } finally {
            setLoadingState(finalGetRecipeBtn, loaderFinal, btnTextFinal, false);
        }
    }
    
    async function fetchIngredientsForDish() {
        const dishName = dishNameInput.value.trim();
        if (!dishName) {
            showError('Please enter a dish name.');
            return;
        }
        setLoadingState(getIngredientsByNameBtn, loaderByName, btnTextByName, true);
        errorDiv.classList.add('hidden');

        try {
            const response = await fetch('http://localhost:3000/get-ingredients-for-dish', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dishName })
            });
            const data = await handleServerResponse(response);
            populateIngredientChecklist(data.ingredients);
        } catch (error) {
             let errorMessage = `Error: ${error.message}`;
            if (error.name === 'TypeError') errorMessage += '\n\nIs your backend server running?';
            showError(errorMessage);
        } finally {
             setLoadingState(getIngredientsByNameBtn, loaderByName, btnTextByName, false);
        }
    }

    function populateIngredientChecklist(ingredients) {
        checklistContainer.innerHTML = '';
        ingredients.forEach(ingredient => {
            const div = document.createElement('div');
            div.className = 'checklist-item';
            div.innerHTML = `
                <label class="flex items-center space-x-3">
                    <input type="checkbox" checked class="form-checkbox h-5 w-5 text-orange-600 bg-gray-700 border-gray-600 rounded focus:ring-orange-500">
                    <span>${ingredient}</span>
                </label>
            `;
            checklistContainer.appendChild(div);
        });
        ingredientChecklistModal.style.display = 'block';
    }

    function handleIngredientConfirmation() {
        ingredientChecklistModal.style.display = 'none';
        
        tempIngredientLists.have = [];
        tempIngredientLists.need = [];
        checklistContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            const ingredient = checkbox.nextElementSibling.textContent;
            if (checkbox.checked) {
                tempIngredientLists.have.push(ingredient);
            } else {
                tempIngredientLists.need.push(ingredient);
            }
        });

        if(tempIngredientLists.need.length > 0) {
            choiceModal.style.display = 'block';
        } else {
            fetchRecipeFromIngredients(tempIngredientLists.have);
        }
    }

    function generateShoppingLinks(needed) {
        shoppingLinksContainer.innerHTML = '';
        if (needed.length === 0) {
            shoppingLinksContainer.classList.add('hidden');
            return;
        }

        const query = encodeURIComponent(needed.join(', '));
        const blinkitUrl = `https://blinkit.com/s/?q=${query}`;
        const zeptoUrl = `https://www.zeptonow.com/search?q=${query}`;

        shoppingLinksContainer.innerHTML = `
            <h3 class="text-xl font-bold text-gray-100 mb-2">Need Ingredients?</h3>
            <p class="text-gray-400 mb-4">Here are some quick links to order the items you're missing:</p>
            <div class="flex space-x-4">
                <a href="${blinkitUrl}" target="_blank" class="flex-1 text-center bg-pink-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-pink-700 transition">Order on Blinkit</a>
                <a href="${zeptoUrl}" target="_blank" class="flex-1 text-center bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition">Order on Zepto</a>
            </div>
        `;
        shoppingLinksContainer.classList.remove('hidden');
    }

    async function fetchAndShowSavedRecipes() {
        try {
            const response = await fetch('http://localhost:3000/get-recipes');
            const data = await handleServerResponse(response);
            
            savedRecipes = {}; // Clear previous data
            savedRecipesList.innerHTML = '';

            if (data.length === 0) {
                savedRecipesList.innerHTML = '<li class="text-gray-400">No recipes saved yet.</li>';
            } else {
                data.forEach(recipe => {
                    savedRecipes[recipe.id] = recipe;
                    const li = document.createElement('li');
                    li.textContent = recipe.recipe.title || `Recipe with: ${recipe.ingredients.join(', ')}`;
                    li.classList.add('cursor-pointer', 'hover:bg-gray-700', 'p-2', 'rounded-md', 'transition-colors');
                    li.dataset.recipeId = recipe.id;
                    savedRecipesList.appendChild(li);
                });
            }
            savedRecipesContainer.classList.toggle('hidden');
        } catch (error) {
            showError(`Error fetching saved recipes: ${error.message}`);
        }
    }

    async function loadDashboard() {
        try {
            const [popularRes, favouriteRes] = await Promise.all([
                fetch('http://localhost:3000/get-popular-recipes'),
                fetch('http://localhost:3000/get-favourite-recipes')
            ]);

            if (!popularRes.ok || !favouriteRes.ok) {
                 throw new Error('Failed to fetch dashboard data from the server.');
            }

            const popularRecipes = await popularRes.json();
            const favouriteRecipes = await favouriteRes.json();

            renderDashboardList(popularRecipes, 'popularRecipesList');
            renderDashboardList(favouriteRecipes, 'favouriteRecipesList');

        } catch (error) {
            console.error("Failed to load dashboard data:", error);
            document.getElementById('popularRecipesList').innerHTML = '<li class="text-red-400">Could not load recipes.</li>';
            document.getElementById('favouriteRecipesList').innerHTML = '<li class="text-red-400">Could not load recipes.</li>';
        }
    }

    function renderDashboardList(recipes, listId) {
        const listElement = document.getElementById(listId);
        listElement.innerHTML = '';

        if (recipes.length === 0) {
            listElement.innerHTML = `<li class="text-gray-500">${listId === 'favouriteRecipesList' ? 'No favourites yet.' : 'No popular recipes yet.'}</li>`;
            return;
        }

        recipes.forEach(recipe => {
            savedRecipes[recipe.id] = recipe;
            const li = document.createElement('li');
            li.textContent = recipe.recipe.title;
            li.className = 'cursor-pointer hover:text-orange-400 transition-colors';
            li.dataset.recipeId = recipe.id;
            li.onclick = () => {
                const fullRecipe = savedRecipes[recipe.id];
                if (fullRecipe) {
                    openRecipeModal(fullRecipe);
                }
            };
            listElement.appendChild(li);
        });
    }

    async function toggleFavourite(recipeId, buttonElement) {
        const currentStatus = buttonElement.textContent === '‚ù§Ô∏è';
        const newStatus = !currentStatus;

        try {
            const response = await fetch(`http://localhost:3000/recipes/${recipeId}/favourite`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ isFavourite: newStatus })
            });

            if (!response.ok) throw new Error('Failed to update favourite status.');

            buttonElement.textContent = newStatus ? '‚ù§Ô∏è' : 'ü§ç';
            
            if (savedRecipes[recipeId]) {
                savedRecipes[recipeId].isFavourite = newStatus;
            }
            
            loadDashboard();

        } catch (error) {
            console.error("Error toggling favourite:", error);
            showError("Could not update favourite status. Please try again.");
        }
    }
    
    updateCombinedListUI();
</script>
</body>

</html>

